---
title: "Statistical Inference and Power Analysis for Direct and Spillover Effects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{interference_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette addresses the usage of the functions involved in statistical inference and power analysis for the direct and spillover effects in two-stage randomized experiments motivated by the JD data set.

## Study Design
In 2007, the ministry in charge of employment in France launched a public employment integration service contract for young graduates seeking employment. A randomized experiment of this job placement assistance program was conducted and the methods in this package can be used to analyze the data. The following examples focus on two specific outcomes: fixed-term contract of six months or more (LTFC) and permanent contract (PC).

## Data
The data set is a subset of the original JD data set and includes the following variables:

`anonale`: local employment agency

`tempsc_av`: full-time work (at time of assignment)

`assigned`: 1 if the individual is assigned to treatment, 0 otherwise

`pct0`: share of the local population treated

`cdi`: binary variable for whether the individual works on a permanent contract, 8 months after the assignment

`cdd6m`: binary variable for whether the individual works in CDD (LTFC-time contract) for more than 6 months, 8 months after the assignment

`emploidur`: binary variable for whether the individual works on a permanent or LTFC-term contract for more than 6 months, 8 months after the assignment

`tempsc`: binary variable for whether the individual works full time, 8 months after the assignment

`salaire`: individual's salary in Euros.

## Overview
The relevant functions for this analysis are the following:

1. `CalAPO`: returns a list of point estimates and variances for the average potential outcomes, unit level direct effect, marginal direct effect, and unit level spillover effect.

2. `Test2SRE`: returns the rejection region for the desired test. This function takes in the data, the effect type (i.e. direct effect, marginal direct effect, or spillover effect) and outputs the rejection region at the desired significance level.

3. `calpara`: returns a list of the estimated within-cluster variance, between cluster variance, intraclass correlation coefficient, and average of the assignment vector which are necessary for the `Clsamplesize` 


4. `Calsamplesize`: returns a list of the necessary total number of clusters in order to achieve a given power level at a given significance level for the three types of effects.

## Functions
First, import the RCT2 library and load the relevant data set.
```{r, include=FALSE}
devtools::load_all(".")
```


```{r}
library(RCT2)
data <- RCT2::jd
```

### CalAPO
In order to calculate a list of point estimates and variances for an effect of interest, run the CalAPO command. It is necessary first to extract `Z`, the vector of treatment assignments, `A`, the vector of treatment assignment mechanisms and `Y.perm`, the vector of potential outcomes for the variable of interest from the data. In this case, we are interested in long-term fixed contracts, and permanent contracts.

```{r, include = F}
#Change the data format to vectors of lists
lea.label <- unique(data$anonale) 
## total number of clusters
 n.lea <- length(lea.label)
 Z <- vector("list", n.lea)
 Y.salary <- vector("list", n.lea) 
 Y.LTFC <- vector("list", n.lea) 
 Y.LT <- vector("list", n.lea) 
 Y.perm <- vector("list", n.lea) 
 A <- numeric(n.lea)
 for ( i in 1:n.lea){
   Z[[i]] <- data$assigned[data$anonale == lea.label[i]]
   
   ## salary    0  for unemployed
   Y.salary[[i]] <- data$salaire[data$anonale == lea.label[i]]
   Y.salary[[i]] <- ifelse(is.na(Y.salary[[i]]),0,Y.salary[[i]])
   
   ## LTFC or permanent contract
   Y.LT[[i]] <- data$emploidur[data$anonale == lea.label[i]]
   ## long-term fixed contract
   Y.LTFC[[i]] <- data$cdd6m[data$anonale == lea.label[i]]
   ## permanent contract
   Y.perm[[i]] <- data$cdi[data$anonale == lea.label[i]]
 }
 
 
 ## treatment assignment mechanism
 for (i in 1:n.lea){
   if (  data$pct0[data$anonale==lea.label[i]][1]== 0.25){A[i] <- 1}
   if (  data$pct0[data$anonale==lea.label[i]][1]== 0.5){A[i] <- 2}
   if (  data$pct0[data$anonale==lea.label[i]][1]== 0.75){A[i] <- 3}
 }
```


Then, run the `CalAPO` command, which takes in the vector of treatment assignments, the assignment mechanism vector, and the vector of outcomes for the variable of interest which is `Y.LTFC` in this case. We see that the estimated average potential outcome for long-term fixed contracts is given by `Y.hat`. As stated in the paper, we also have the results for the estimated direct effects under the three treatment mechanisms (`ADE.est`), the estimated marginal direct effect (`MDE.est`), and the estimated spillover effects (`ASE.est`). We also have the estimated covariance matrices for the average potential outcomes, the estimated direct effect, estimated marginal effect, and estimated spillover effects.

```{r}
RCT2::CalAPO(Z,A,Y.LTFC)
```

Similarly, we can run this on the permanent contracts.

```{r}
RCT2::CalAPO(Z, A, Y.perm)
```


### Test2SRE
We can also perform hypothesis tests on this data by using the `Test2SRE` function. THE `Test2SRE` function takes in `Z`, `A`, `Y`, as before, and also takes in an extra argument `effect`, where the desired effect should be specified (either ADE for direct effect, MDE for marginal direct effect, or ASE for spillover effect). The function returns `TRUE` if the hypothesis should be rejected, and `FALSE` otherwise. The default significance level is set to 0.05, but may be changed by altering the `alpha` argument.

```{r}
RCT2::Test2SRE(Z,A,Y.LTFC,effect="MDE", alpha=0.05)
```

### Calpara and Calsamplesize  
Lastly, we can perform sample size calculations for the sample size needed for a given power at a given significance level. First, we call the `calpara` function to calculate the necessary parameters for the sample size calculation, including the within-class and between class variances and the intraclass correlation coefficient. The effect size and the assignment mechanism also need to be specified.

```{r}
### effect size and assignment mechanism
mu <- 0.05
pa <- c( 0.25,0.50, 0.75)
qa <- rep(1/3,3)

# calculate parameters for permanent contract
var.perm <- Calpara(Z,A,Y.perm)
n.avg <- round(var.perm$n)
var.perm$sigmab / (var.perm$sigmab+var.perm$sigmaw)
sigma.perm <- var.perm$sigmab+var.perm$sigmaw


# calculate parameters for long term fixed contract
var.LTFC <- Calpara(Z,A,Y.LTFC)
var.LTFC$sigmab / (var.LTFC$sigmab+var.LTFC$sigmaw)
sigma.LTFC <- var.LTFC$sigmab+var.LTFC$sigmaw

```


Then, we specify the effect size and use the `Calsamplesize` function to calculate the appropriate sample sizes for the permanent contract and the LTFC. 

```{r}
# calculate sample size for the permanent contract
print("Permanent Contract:")
round(RCT2::Calsamplesize(0.03,n.avg,qa, pa, r=var.perm$r, sigma.perm, alpha=0.05, beta=0.2))


# calculate sample size for the long term fixed contract
print("Long Term Fixed Contract")
round(RCT2::Calsamplesize(0.03,n.avg,qa, pa, r=var.LTFC$r, sigma.LTFC, alpha=0.05, beta=0.2))
```

From the results, we can see the necessary sample sizes needed to detect a specific alternative at a certain power and significance level.